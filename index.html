<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Ronnie Soap Scan</title>

  <style>
    :root{
      --green:#1b5e20;
      --orange:#f57c00;
      --bg:#ffffff;
      --text:#111;
      --muted:#444;
    }
    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow:hidden; /* kiosk-friendly */
      touch-action: manipulation;
    }
    .wrap{
      height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 26px 18px;
      gap: 14px;
    }
    .title{
      font-size: 56px;
      font-weight: 900;
      line-height: 1.0;
      letter-spacing: -0.02em;
    }
    .subtitle{
      font-size: 22px;
      color: var(--muted);
      font-weight: 700;
    }
    .status{
      display:none;
      margin-top: 6px;
      font-size: 42px;
      font-weight: 1000;
      line-height: 1.0;
      padding: 14px 18px;
      border-radius: 18px;
      border: 3px solid transparent;
    }
    .success{
      display:inline-block;
      color: var(--green);
      border-color: rgba(27,94,32,.25);
      background: rgba(27,94,32,.06);
    }
    .toosoon{
      display:inline-block;
      color: var(--orange);
      border-color: rgba(245,124,0,.25);
      background: rgba(245,124,0,.08);
    }
    .countdown{
      display:none;
      font-size: 24px;
      font-weight: 800;
      color: var(--muted);
      margin-top: 6px;
    }
    .btn{
      margin-top: 10px;
      width: min(520px, 92vw);
      padding: 18px 18px;
      font-size: 28px;
      font-weight: 900;
      border-radius: 22px;
      border: 0;
      background: var(--green);
      color: white;
    }
    .btn:active{ transform: scale(0.99); }
    .btn[disabled]{
      opacity: 0.55;
      background: #2e7d32;
    }
    .hint{
      margin-top: 8px;
      font-size: 14px;
      color:#666;
    }

    /* confetti */
    .confetti{
      position: fixed;
      inset: 0;
      pointer-events:none;
      overflow:hidden;
      display:none;
    }
    .confetti i{
      position:absolute;
      top:-10vh;
      width: 10px;
      height: 18px;
      opacity: 0.95;
      border-radius: 2px;
      animation: fall 1200ms linear forwards;
    }
    @keyframes fall{
      to { top: 110vh; transform: rotate(540deg); }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">ðŸ§¼ Ronnie</div>
    <div class="subtitle">Wash with soap, then tap the button</div>

    <button id="confirmBtn" class="btn">âœ… I washed my hands!</button>

    <div id="status" class="status"></div>
    <div id="countdown" class="countdown"></div>

    <div class="hint">Tip: You can leave this open. It wonâ€™t do anything until you tap.</div>
  </div>

  <div id="confetti" class="confetti"></div>

  <script>
    const WEBHOOK =
      "https://bfamassist.duckdns.org:8123/api/webhook/ronnie-soap-scan-jgqz_pNdPB6c91AyMaZDyGVB";
    const KEY = "R0nn13SoapKey2026";

    // Match your HA timer: 30 minutes
    const COOLDOWN_MS = 1800000;

    // prevent double-taps / iOS weirdness
    const TAP_DEBOUNCE_MS = 1500;

    const btn = document.getElementById("confirmBtn");
    const statusEl = document.getElementById("status");
    const countdownEl = document.getElementById("countdown");
    const confettiEl = document.getElementById("confetti");

    function fmt(ms){
      const totalSec = Math.max(0, Math.ceil(ms/1000));
      const m = Math.floor(totalSec/60);
      const s = totalSec % 60;
      return `${m}:${String(s).padStart(2,'0')}`;
    }

    function showTooSoon(msLeft){
      statusEl.style.display = "inline-block";
      statusEl.className = "status toosoon";
      statusEl.textContent = "â³ TOO SOON";

      countdownEl.style.display = "block";
      countdownEl.textContent = `Try again in ${fmt(msLeft)}`;

      const interval = setInterval(() => {
        const last = Number(localStorage.getItem("ronnieSoapLastSuccess") || "0");
        const ms = COOLDOWN_MS - (Date.now() - last);
        if (ms <= 0) {
          clearInterval(interval);
          countdownEl.textContent = "Ready âœ…";
          statusEl.className = "status success";
          statusEl.textContent = "âœ… READY!";
          btn.disabled = false;
        } else {
          countdownEl.textContent = `Try again in ${fmt(ms)}`;
        }
      }, 1000);
    }

    function launchConfetti(){
      confettiEl.innerHTML = "";
      confettiEl.style.display = "block";
      const colors = ["#1b5e20","#2e7d32","#f57c00","#ffb300","#1976d2","#7b1fa2","#d32f2f"];
      for (let i=0; i<28; i++){
        const p = document.createElement("i");
        p.style.left = (Math.random()*100) + "vw";
        p.style.animationDelay = (Math.random()*250) + "ms";
        p.style.animationDuration = (900 + Math.random()*700) + "ms";
        p.style.width = (8 + Math.random()*8) + "px";
        p.style.height = (12 + Math.random()*16) + "px";
        p.style.background = colors[Math.floor(Math.random()*colors.length)];
        confettiEl.appendChild(p);
      }
      setTimeout(() => { confettiEl.style.display = "none"; }, 1400);
    }

    function resetUI(){
      statusEl.style.display = "none";
      countdownEl.style.display = "none";
      btn.disabled = false;
    }

    // On load, show READY or TOO SOON based on last success (visual mirror)
    (function init(){
      const last = Number(localStorage.getItem("ronnieSoapLastSuccess") || "0");
      const remaining = COOLDOWN_MS - (Date.now() - last);

      if (remaining > 0) {
        btn.disabled = true;
        showTooSoon(remaining);
      } else {
        resetUI();
        statusEl.style.display = "inline-block";
        statusEl.className = "status success";
        statusEl.textContent = "âœ… READY!";
      }
    })();

    btn.addEventListener("click", () => {
      const now = Date.now();
      const lastTap = Number(localStorage.getItem("ronnieSoapLastTap") || "0");
      if (now - lastTap < TAP_DEBOUNCE_MS) return;
      localStorage.setItem("ronnieSoapLastTap", String(now));

      // Fire HA webhook ONLY on tap
      const img = new Image();
      img.src = WEBHOOK + "?k=" + encodeURIComponent(KEY) + "&t=" + now;

      // Update UI immediately for Ronnie (HA will speak)
      localStorage.setItem("ronnieSoapLastSuccess", String(now));
      btn.disabled = true;

      statusEl.style.display = "inline-block";
      statusEl.className = "status success";
      statusEl.textContent = "âœ… SUCCESS!";

      countdownEl.style.display = "block";
      countdownEl.textContent = "Nice job!";

      launchConfetti();

      // Start countdown display
      setTimeout(() => {
        showTooSoon(COOLDOWN_MS);
      }, 700);
    });
  </script>
</body>
</html>
